# 爬虫方案实施总结

**完成日期**: 2024-12-31
**方案**: 直接调用网易云 Web API（替代 NeteaseCloudMusicApi）

---

## 1. 问题背景

NeteaseCloudMusicApi 项目已于2024年1月停止维护，存在以下问题：
- ❌ 已停止维护，不再更新
- ❌ 使用可能导致网易云音乐账号被冻结
- ❌ YesPlayMusic 等项目已发出警告

**参考**:
- [YesPlayMusic Issue #2311](https://github.com/qier222/YesPlayMusic/issues/2311)

---

## 2. 解决方案

### 方案选择

经过调研（详见 `2024-12-31_数据获取替代方案调研.md`），选择**直接爬虫方案**：

**原理**: 直接分析网易云 Web 端 API 接口，模拟发送 HTTP 请求

**优势**:
- ✅ 自主可控，不依赖第三方项目
- ✅ 实时更新，网易云更新接口时可快速跟进
- ✅ 无账号风险，无需登录
- ✅ 轻量级，只需要 requests 库

---

## 3. 实施过程

### 3.1 API 接口测试

创建 `tests/test_api_endpoints.py` 测试网易云 Web API：

**测试结果**:
- ✅ 搜索接口可用: `/api/search/get/web`
- ✅ 详情接口可用: `/api/song/detail`
- ❌ 风格标签不可用: `/api/song/detail` 不返回 `songTag` 字段
- ⚠️ 评论接口加密: 需要逆向加密参数（推迟到V2版本）

### 3.2 创建爬虫客户端

**文件**: `src/core/netease_crawler.py` (218行)

**核心功能**:

1. **搜索歌曲** - `search_song(song_name, artist_name)`
   - 接口: `https://music.163.com/api/search/get/web`
   - 参数: `s={song_name} {artist_name}&type=1&offset=0&limit=5`
   - 返回: song_id (str)

2. **获取歌曲详情** - `get_song_detail(song_id)`
   - 接口: `https://music.163.com/api/song/detail`
   - 参数: `ids=["{song_id}"]` (JSON数组格式)
   - 返回: SongInfo 对象
   - **注意**: 风格标签暂不可用，显示"暂不可用"

3. **获取热门评论** - `get_hot_comments(song_id)`
   - **MVP版本**: 返回占位符评论
   - **V2版本**: 将实现真实评论获取（需要逆向加密算法）

**特性**:
- LRU 缓存 (maxsize=50)
- 请求频率限制（1秒间隔）
- 重试机制（指数退避，最多3次）
- 日志记录

### 3.3 更新主程序

**修改文件**: `src/main.py`

**改动**:
```python
# 旧代码
from src.core.api_client import NeteaseAPIClient
self.api_client = NeteaseAPIClient()

# 新代码
from src.core.netease_crawler import NeteaseMusicCrawler
self.crawler = NeteaseMusicCrawler()
```

### 3.4 更新配置文件

**修改文件**: `src/config/settings.py`

**改动**:
- 移除 `api_base_url` 配置（不再需要）
- 更新注释说明：使用网易云官方 Web API，无需本地 API 服务

---

## 4. 测试验证

### 4.1 完整流程测试

**文件**: `tests/test_crawler.py`

**测试结果**:
```
✅ 测试1: 搜索歌曲 - 成功找到歌曲ID: 543965520
✅ 测试2: 获取歌曲详情 - 成功获取歌名、歌手、专辑、时长
✅ 测试3: 获取热门评论 - 返回占位符评论
✅ 测试4: 缓存测试 - 缓存工作正常
✅ 测试5: 异常处理 - 正确处理网络错误
```

### 4.2 参数格式测试

**文件**: `tests/test_detail_params.py`

**发现**: `/api/song/detail` 接口需要 JSON 数组格式
- ✅ `ids=["543965520"]` (双引号) - 成功
- ✅ `ids=['543965520']` (单引号) - 成功
- ❌ `ids=543965520` (纯字符串) - 失败（400错误）

---

## 5. MVP版本功能

### 已实现功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 窗口标题读取 | ✅ | 识别当前播放歌曲 |
| 搜索歌曲 | ✅ | 根据歌名和歌手搜索，获取 song_id |
| 获取歌曲详情 | ✅ | 歌名、歌手、专辑、时长 |
| 音乐风格标签 | ⚠️ | 暂不可用（API不返回该字段） |
| 热门评论 | ⚠️ | 显示占位符（V2版本实现） |
| 评论轮播 | ⚠️ | V2版本实现 |
| 透明悬浮窗口 | ✅ | 320x180，可拖动 |
| 缓存机制 | ✅ | LRU Cache，减少重复请求 |

### MVP版本限制

1. **音乐风格标签不可用**
   - 原因: 网易云 `/api/song/detail` 接口不返回 `songTag` 字段
   - 显示: "暂不可用"
   - V2方案: 尝试其他接口或逆向分析

2. **热门评论功能受限**
   - 原因: 评论接口需要加密参数（`params` 和 `encSecKey`）
   - MVP实现: 显示占位符 "评论功能开发中，敬请期待..."
   - V2方案: 逆向分析加密算法

3. **评论轮播暂不支持**
   - 原因: 暂无多条评论数据
   - V2方案: 获取真实评论后实现轮播

---

## 6. V2版本规划

### 6.1 评论功能完整实现

**任务**: 逆向分析评论接口加密算法

**接口**: `/api/v1/resource/comments/R_SO_4_{song_id}`

**加密参数**:
- `params`: AES 加密的请求参数
- `encSecKey`: RSA 加密的密钥

**实施步骤**:
1. 使用浏览器开发者工具抓包分析
2. 找到 JavaScript 中的加密逻辑
3. 用 Python 重写加密算法
4. 测试验证

**参考资源**:
- [网易云评论爬虫代码 (2025-6-5)](https://blog.csdn.net/qq_69034773/article/details/148460471)
- [实战：网易云音乐评论爬取（附加密算法）](https://segmentfault.com/a/1190000014948845)

### 6.2 音乐风格优化

**可能方案**:
1. 尝试其他网易云 API 接口获取风格
2. 集成 Last.fm API（6000+ 详细子流派）
3. 本地风格映射表

---

## 7. 代码统计

### 新增文件

| 文件 | 行数 | 说明 |
|------|------|------|
| `src/core/netease_crawler.py` | 218 | 网易云爬虫客户端 |
| `tests/test_api_endpoints.py` | 150 | API接口测试 |
| `tests/test_detail_params.py` | 72 | 参数格式测试 |
| `tests/test_crawler.py` | 71 | 完整流程测试 |
| **总计** | **511** | **4个新文件** |

### 修改文件

| 文件 | 改动 |
|------|------|
| `src/main.py` | 导入和实例化改用 `NeteaseMusicCrawler` |
| `src/config/settings.py` | 移除 `api_base_url` 配置 |
| `README.md` | 更新说明，移除本地API服务要求 |

---

## 8. 风险评估

### 法律风险

- ⚠️ **注意**: 爬虫应遵守网站使用条款
- ⚠️ **学习目的**: 仅用于个人学习，不用于商业用途
- ⚠️ **频率控制**: 已实现1秒请求间隔，避免对服务器造成过大压力

### 技术风险

- ⚠️ **接口变化**: 网易云可能更新接口或加密算法
- ⚠️ **IP限制**: 可能会限制请求频率（已实现频率控制）
- ✅ **无封号风险**: 不使用登录状态，不使用官方客户端

---

## 9. 总结

### 成果

✅ **成功实施爬虫方案**，替代已停止维护的 NeteaseCloudMusicApi
✅ **MVP版本可运行**，核心功能完整
✅ **无需本地API服务**，简化部署
✅ **自主可控**，不依赖第三方项目

### 优势

- ✅ **简单易用**: 直接运行 `scripts/run.bat` 即可
- ✅ **无账号风险**: 不使用登录状态
- ✅ **可持续**: 接口更新时可快速跟进

### 下一步工作

1. **V2版本**: 逆向分析评论接口加密算法
2. **用户测试**: 实际使用测试，收集反馈
3. **性能优化**: 异步加载，优化请求频率

---

**文档状态**: ✅ MVP版本实施完成

**最后更新**: 2024-12-31
