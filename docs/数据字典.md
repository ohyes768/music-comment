# 网易云音乐评论桌面应用 - 数据字典 (V2.0)

**文档版本**: v2.0
**创建日期**: 2024-12-30
**最后更新**: 2025-01-02

---

## 1. 数据概述

本项目采用**内存存储 + 文件存储**的方式，不使用传统数据库。

| 存储类型 | 用途 | 位置 |
|----------|------|------|
| 内存缓存 | 临时数据、缓存 | Python 进程内存 |
| 配置文件 | 用户配置 | `~/.music-comment/config.json` |
| 日志文件 | 运行日志 | `logs/music-comment.log` |
| **加密密钥** | V2.0新增：RSA密钥对 | `~/.music-comment/keys/` |
| **加密数据** | V2.0新增：加密的评论内容 | `~/.music-comment/cache/encrypted_comments.json` |

---

## 2. 数据模型

### 2.1 数据模型概览 (V2.0 更新)

```
┌─────────────────────────────────────────┐
│            SongInfo (歌曲信息)            │
│  song_id: str                           │
│  name: str                              │
│  artist: str                            │
│  album: str                             │
│  genres: List[str]                      │
│  duration: int                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│           Comment (评论) V2.0             │
│  content: str                           │
│  user: str                              │
│  likes: int                             │
│  time: str                              │
│  encrypted_content: str     (新增)      │
│  encrypted_key: str         (新增)      │
│  signature: str             (新增)      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      CryptoKey (加密密钥) V2.0新增       │
│  key_type: str (RSA/AES)               │
│  key_data: str                          │
│  key_size: int                          │
│  created_at: datetime                   │
│  expires_at: datetime                   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│     AppConfig (应用配置) V2.0增强        │
│  show_real_comments: bool               │
│  rotation_settings: dict                │
│  encryption_config: dict                │
└─────────────────────────────────────────┘
```

### 2.2 SongInfo（歌曲信息）

**职责**: 存储歌曲的基本信息

**字段定义**:

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 | 示例 |
|--------|------|------|------|--------|------|------|
| song_id | str | 20 | 是 | - | 网易云歌曲ID | "347230" |
| name | str | 200 | 是 | - | 歌曲名称 | "浪人情歌" |
| artist | str | 100 | 是 | - | 歌手名称 | "伍佰" |
| album | str | 200 | 否 | "" | 专辑名称 | "爱情的尽头" |
| genres | List[str] | - | 否 | [] | **音乐风格列表（从API的songTag字段获取）** | ["流行", "摇滚"] |
| duration | int | - | 否 | 0 | 时长（秒） | 283 |

**🔑 关于 genres 字段**:
- **数据来源**: 优先从网易云API的 `songTag` 字段获取（官方曲风标签）
- **备选方案**: 如果 `songTag` 为空，使用 `alias` 字段（歌曲别名）
- **最终降级**: 如果都为空，使用 `["未知风格"]`
- **显示策略**: 最多显示3个标签，用 " / " 分隔
- **参考文档**: [音乐风格获取方案调研](../discuss/2024-12-30_音乐风格获取方案调研.md)

**数据示例**:
```json
{
  "song_id": "347230",
  "name": "浪人情歌",
  "artist": "伍佰",
  "album": "爱情的尽头",
  "genres": ["流行", "摇滚", "民谣"],
  "duration": 283
}
```

**代码定义**:
```python
from dataclasses import dataclass
from typing import List

@dataclass
class SongInfo:
    """歌曲信息模型"""
    song_id: str
    name: str
    artist: str
    album: str = ""
    genres: List[str] = None
    duration: int = 0

    def __post_init__(self):
        if self.genres is None:
            self.genres = []

    def get_genres_str(self) -> str:
        """获取风格字符串（最多显示3个）"""
        if not self.genres:
            return "未知风格"
        # 最多显示3个标签
        display_genres = self.genres[:3]
        return " / ".join(display_genres)
```

**API 映射示例**:
```python
def map_song_info_from_api(song_data: dict) -> SongInfo:
    """从API响应映射到SongInfo（智能降级）"""
    # 优先使用 songTag，如果为空则使用 alias，最后使用默认值
    genres = song_data.get("songTag", [])
    if not genres:
        alias = song_data.get("alias", [])
        genres = alias if alias else ["未知风格"]

    return SongInfo(
        song_id=str(song_data['id']),
        name=song_data['name'],
        artist=song_data['artists'][0]['name'],
        album=song_data.get('album', {}).get('name', ''),
        genres=genres,
        duration=song_data.get('duration', 0) // 1000
    )
```

---

### 2.3 Comment（评论）V2.0增强

**职责**: 存储评论信息，新增加密字段支持

**字段定义**:

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 | 示例 |
|--------|------|------|------|--------|------|------|
| content | str | 1000 | 是 | - | 评论内容（V2.0可加密） | "这首歌很感动..." |
| encrypted_content | str | 2048 | 否 | "" | V2.0新增：AES加密的评论内容 | "U2FsdGVkX1+..." |
| user | str | 100 | 是 | - | 用户昵称 | "音乐爱好者" |
| likes | int | - | 是 | 0 | 点赞数 | 1234 |
| time | str | 50 | 否 | "" | 评论时间 | "1489154546341" |
| encrypted_key | str | 512 | 否 | "" | V2.0新增：RSA加密的AES密钥 | "U2FsdGVkX1/..." |
| signature | str | 128 | 否 | "" | V2.0新增：SHA256签名 | "SHA256:abc123..." |
| display_mode | str | 20 | 否 | "real" | V2.0新增：显示模式 | "real"\|"encrypted"\|"mixed" |

**V2.0 数据示例**：
```json
{
  "content": "这首歌每次听都很感动，尤其是前奏响起的时候...",
  "encrypted_content": "U2FsdGVkX1+eB7C3p9K6wJXqR6L9mN3QZ4T8V2Y8WqE=",
  "user": "用户昵称",
  "likes": 12345,
  "time": "1489154546341",
  "encrypted_key": "U2FsdGVkX1/abc123def456...",
  "signature": "SHA256:abc123def4567890...",
  "display_mode": "real"
}
```

**V2.0 加密字段说明**：
- `encrypted_content`: 使用AES加密的评论内容，确保传输安全
- `encrypted_key`: 使用RSA加密的AES密钥，用于解密评论内容
- `signature`: SHA256数字签名，确保数据完整性和防篡改
- `display_mode`: 控制评论显示模式（真实/加密/混合）

**V2.0 代码定义**：
```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class Comment:
    """V2.0 增强版评论信息模型"""
    content: str
    user: str
    likes: int
    time: str = ""

    # V2.0 新增加密字段
    encrypted_content: str = ""
    encrypted_key: str = ""
    signature: str = ""
    display_mode: str = "real"  # "real", "encrypted", "mixed"

    def is_encrypted(self) -> bool:
        """检查评论是否加密"""
        return bool(self.encrypted_content and self.encrypted_key)

    def get_display_content(self) -> str:
        """获取显示内容（根据display_mode）"""
        if self.display_mode == "encrypted":
            return self.encrypted_content
        elif self.display_mode == "mixed":
            # 随机返回真实或加密内容
            import random
            return random.choice([self.content, self.encrypted_content])
        else:  # "real"
            return self.content

    def verify_signature(self, public_key) -> bool:
        """V2.0新增：验证数据签名"""
        # 验证逻辑实现
        pass
```

---

### 2.4 AppConfig（应用配置）V2.0增强

**职责**: 存储应用配置信息，V2.0新增加密和轮播增强配置

**字段定义**:

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| **窗口配置** | | | |
| window_width | int | 320 | 窗口宽度（像素） |
| window_height | int | 180 | 窗口高度（像素） |
| window_opacity | float | 0.85 | 窗口透明度（0-1） |
| **评论轮播配置（V2.0增强）** | | | |
| rotation_interval | int | 5000 | 评论轮播间隔（毫秒） |
| rotation_animation_duration | int | 500 | 动画时长（毫秒） |
| rotation_auto_pause | bool | True | V2.0新增：自动暂停（鼠标悬停） |
| rotation_manual_pause | bool | True | V2.0新增：允许手动暂停 |
| rotation_smart_interval | bool | True | V2.0新增：智能间隔（根据评论长度） |
| rotation_min_interval | int | 3000 | V2.0新增：最小间隔（毫秒） |
| rotation_max_interval | int | 10000 | V2.0新增：最大间隔（毫秒） |
| rotation_memory_position | bool | True | V2.0新增：记忆位置 |
| **评论显示配置（V2.0新增）** | | | |
| show_real_comments | bool | True | V2.0新增：显示真实评论 |
| show_encrypted_comments | bool | False | V2.0新增：显示加密评论（调试用） |
| decryption_timeout | int | 10000 | V2.0新增：解密超时（毫秒） |
| **加密配置（V2.0新增）** | | | |
| encryption_enabled | bool | True | V2.0新增：启用加密 |
| encryption_algorithm | str | "AES+RSA" | V2.0新增：加密算法 |
| aes_key_size | int | 256 | V2.0新增：AES密钥长度 |
| rsa_key_size | int | 2048 | V2.0新增：RSA密钥长度 |
| **API配置** | | | |
| api_base_url | str | "http://localhost:3000" | API 服务地址 |
| api_timeout | int | 10 | API 请求超时（秒） |
| max_retries | int | 3 | 最大重试次数 |
| **缓存配置** | | | |
| cache_size | int | 50 | 缓存大小 |
| comment_cache_time | int | 3600 | 评论缓存时间（秒） |

**V2.0 数据示例**:
```json
{
  "window_width": 320,
  "window_height": 180,
  "window_opacity": 0.85,
  "rotation_interval": 5000,
  "rotation_animation_duration": 500,
  "rotation_auto_pause": true,
  "rotation_manual_pause": true,
  "rotation_smart_interval": true,
  "rotation_min_interval": 3000,
  "rotation_max_interval": 10000,
  "rotation_memory_position": true,
  "show_real_comments": true,
  "show_encrypted_comments": false,
  "decryption_timeout": 10000,
  "encryption_enabled": true,
  "encryption_algorithm": "AES+RSA",
  "aes_key_size": 256,
  "rsa_key_size": 2048,
  "api_base_url": "http://localhost:3000",
  "api_timeout": 10,
  "max_retries": 3,
  "cache_size": 50,
  "comment_cache_time": 3600
}
```

---

## 3. V2.0 新增数据模型

### 3.1 CryptoKey（加密密钥）

**职责**: V2.0新增，管理加密密钥对

**字段定义**:

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 | 示例 |
|--------|------|------|------|--------|------|------|
| key_type | str | 20 | 是 | - | 密钥类型（RSA/AES） | "RSA" |
| key_data | str | 4096 | 是 | - | 密钥数据（Base64编码） | "-----BEGIN RSA..." |
| key_size | int | - | 是 | - | 密钥长度（位） | 2048 |
| created_at | datetime | - | 否 | - | 创建时间 | "2025-01-02T10:30:00" |
| expires_at | datetime | - | 否 | - | 过期时间（可选） | "2025-12-31T23:59:59" |
| algorithm | str | 50 | 否 | - | 加密算法 | "AES-256-CBC" |

**数据示例**:
```json
{
  "key_type": "RSA",
  "key_data": "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...\n-----END RSA PRIVATE KEY-----",
  "key_size": 2048,
  "created_at": "2025-01-02T10:30:00Z",
  "expires_at": "2025-12-31T23:59:59Z",
  "algorithm": "RSA-2048-OAEP"
}
```

**存储位置**: `~/.music-comment/keys/`
- `private_key.pem`: RSA私钥
- `public_key.pem`: RSA公钥
- `key_metadata.json`: 密钥元数据

### 3.2 EncryptedComment（加密评论）

**职责**: V2.0新增，存储加密的评论数据

**字段定义**:

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 | 示例 |
|--------|------|------|------|--------|------|------|
| song_id | str | 20 | 是 | - | 歌曲ID | "347230" |
| encrypted_content | str | 2048 | 是 | - | AES加密的评论内容 | "U2FsdGVkX1+..." |
| encrypted_key | str | 512 | 是 | - | RSA加密的AES密钥 | "U2FsdGVkX1/..." |
| signature | str | 128 | 是 | - | SHA256签名 | "SHA256:abc123..." |
| timestamp | datetime | - | 是 | - | 加密时间 | "2025-01-02T10:30:00" |
| user_info | dict | - | 否 | - | 用户信息（脱敏） | {"nickname": "用户"} |

**数据示例**:
```json
{
  "song_id": "347230",
  "encrypted_content": "U2FsdGVkX1+eB7C3p9K6wJXqR6L9mN3QZ4T8V2Y8WqE=",
  "encrypted_key": "U2FsdGVkX1/abc123def456...",
  "signature": "SHA256:abc123def4567890...",
  "timestamp": "2025-01-02T10:30:00Z",
  "user_info": {
    "nickname": "音乐爱好者",
    "avatar_url": "https://p1.music.126.net/..."
  }
}
```

**存储位置**: `~/.music-comment/cache/encrypted_comments.json`

---

## 4. 缓存数据结构

### 4.1 内存缓存

**缓存类型**: LRU Cache (Least Recently Used)

**缓存结构**:
```python
# 搜索缓存
search_cache = {
    (song_name, artist_name): song_id
}

# 歌曲详情缓存
song_cache = {
    song_id: SongInfo
}

# 评论缓存（V2.0加密）
comment_cache = {
    song_id: {
        'encrypted_comments': list,  # 加密的评论列表
        'timestamp': float,          # 缓存时间戳
        'decrypted_comments': list  # 解密后的评论（可选）
    }
}

# 加密密钥缓存（V2.0新增）
crypto_cache = {
    'rsa_public_key': str,      # RSA公钥
    'rsa_private_key': str,     # RSA私钥
    'last_generated': float     # 最后生成时间
}
```

**V2.0 缓存配置**:

| 参数 | 值 | 说明 |
|------|---|------|
| maxsize | 50 | 最大缓存条目数 |
| ttl (song) | 86400 | 歌曲详情缓存时间（24小时） |
| ttl (encrypted_comment) | 3600 | V2.0：加密评论缓存时间（1小时） |
| ttl (decrypted_comment) | 1800 | V2.0：解密评论缓存时间（30分钟） |
| ttl (crypto_key) | 86400 | V2.0：加密密钥缓存时间（24小时） |
| decryption_workers | 2 | V2.0：解密线程数 |
| cache_encrypted_only | true | V2.0：仅缓存加密评论（节省内存） |

**V2.0 代码实现**:
```python
from functools import lru_cache
import time
from typing import Dict, List, Optional

class CacheManager:
    """V2.0 增强版缓存管理器"""

    def __init__(self):
        # 基础缓存
        self.search_cache = {}  # 搜索缓存
        self.song_cache = {}    # 歌曲详情缓存

        # V2.0 加密评论缓存
        self.encrypted_comment_cache = {}  # 加密评论缓存
        self.decrypted_comment_cache = {}  # 解密评论缓存（带TTL）

        # V2.0 加密密钥缓存
        self.crypto_key_cache = {
            'public_key': None,
            'private_key': None,
            'last_generated': 0
        }

    @lru_cache(maxsize=50)
    def get_song_detail(self, song_id: str) -> SongInfo:
        """获取歌曲详情（带缓存）"""
        # API 调用
        pass

    def get_encrypted_comments(self, song_id: str) -> List[dict]:
        """V2.0：获取加密评论"""
        if song_id in self.encrypted_comment_cache:
            data, timestamp = self.encrypted_comment_cache[song_id]
            if time.time() - timestamp < 3600:  # 1小时
                return data
        # API 调用
        pass

    def get_decrypted_comments(self, song_id: str) -> Optional[List[Comment]]:
        """V2.0：获取解密评论（带TTL）"""
        if song_id in self.decrypted_comment_cache:
            comments, timestamp = self.decrypted_comment_cache[song_id]
            if time.time() - timestamp < 1800:  # 30分钟
                return comments
        return None

    def cache_decrypted_comments(self, song_id: str, comments: List[Comment]):
        """V2.0：缓存解密评论"""
        self.decrypted_comment_cache[song_id] = (comments, time.time())

    def get_crypto_keys(self) -> tuple:
        """V2.0：获取加密密钥"""
        # 检查密钥是否过期
        if time.time() - self.crypto_key_cache['last_generated'] > 86400:
            # 重新生成密钥
            self._generate_new_keys()

        return (
            self.crypto_key_cache['public_key'],
            self.crypto_key_cache['private_key']
        )

    def _generate_new_keys(self):
        """V2.0：生成新的RSA密钥对"""
        from Crypto.PublicKey import RSA

        key = RSA.generate(2048)
        self.crypto_key_cache['public_key'] = key.publickey().export_key().decode()
        self.crypto_key_cache['private_key'] = key.export_key().decode()
        self.crypto_key_cache['last_generated'] = time.time()

    def clear_decrypted_cache(self):
        """V2.0：清除解密缓存（节省内存）"""
        self.decrypted_comment_cache.clear()
```

---

## 5. 配置文件结构

### 4.1 文件位置

```
~/.music-comment/
├── config.json                    # 配置文件
├── cache/                         # 缓存目录（可选）
│   ├── encrypted_comments.json    # V2.0加密评论缓存
│   └── decrypted_comments.json    # V2.0解密评论缓存（临时）
└── keys/                          # V2.0新增：密钥目录
    ├── private_key.pem            # RSA私钥
    ├── public_key.pem             # RSA公钥
    └── key_metadata.json          # 密钥元数据
```

### 5.2 配置文件格式

**文件路径**: `~/.music-comment/config.json`

**V2.0 文件内容**:
```json
{
  "window": {
    "width": 320,
    "height": 180,
    "opacity": 0.85,
    "position": {
      "x": 100,
      "y": 100
    }
  },
  "rotation": {
    "interval": 5000,
    "animation_duration": 500,
    "auto_pause": true,
    "manual_pause": true,
    "smart_interval": true,
    "min_interval": 3000,
    "max_interval": 10000,
    "memory_position": true
  },
  "display": {
    "show_real_comments": true,
    "show_encrypted_comments": false,
    "decryption_timeout": 10000
  },
  "encryption": {
    "enabled": true,
    "algorithm": "AES+RSA",
    "aes_key_size": 256,
    "rsa_key_size": 2048
  },
  "api": {
    "base_url": "http://localhost:3000",
    "timeout": 10,
    "max_retries": 3
  },
  "cache": {
    "size": 50,
    "comment_ttl": 3600,
    "encrypted_comment_ttl": 3600,
    "decrypted_comment_ttl": 1800,
    "cache_encrypted_only": true
  }
}
```

**V2.0 字段说明**:

| 路径 | 类型 | 说明 |
|------|------|------|
| **窗口配置** | | |
| window.width | int | 窗口宽度 |
| window.height | int | 窗口高度 |
| window.opacity | float | 窗口透明度 |
| window.position.x | int | 窗口X坐标 |
| window.position.y | int | 窗口Y坐标 |
| **轮播配置（V2.0增强）** | | |
| rotation.interval | int | 轮播间隔（毫秒） |
| rotation.animation_duration | int | 动画时长（毫秒） |
| rotation.auto_pause | bool | V2.0：自动暂停 |
| rotation.manual_pause | bool | V2.0：手动暂停 |
| rotation.smart_interval | bool | V2.0：智能间隔 |
| rotation.min_interval | int | V2.0：最小间隔 |
| rotation.max_interval | int | V2.0：最大间隔 |
| rotation.memory_position | bool | V2.0：记忆位置 |
| **显示配置（V2.0新增）** | | |
| display.show_real_comments | bool | V2.0：显示真实评论 |
| display.show_encrypted_comments | bool | V2.0：显示加密评论 |
| display.decryption_timeout | int | V2.0：解密超时 |
| **加密配置（V2.0新增）** | | |
| encryption.enabled | bool | V2.0：启用加密 |
| encryption.algorithm | string | V2.0：加密算法 |
| encryption.aes_key_size | int | V2.0：AES密钥长度 |
| encryption.rsa_key_size | int | V2.0：RSA密钥长度 |
| **API配置** | | |
| api.base_url | string | API服务地址 |
| api.timeout | int | 请求超时（秒） |
| api.max_retries | int | 最大重试次数 |
| **缓存配置（V2.0增强）** | | |
| cache.size | int | 缓存大小 |
| cache.comment_ttl | int | 评论缓存时间（秒） |
| cache.encrypted_comment_ttl | int | V2.0：加密评论缓存时间 |
| cache.decrypted_comment_ttl | int | V2.0：解密评论缓存时间 |
| cache.cache_encrypted_only | bool | V2.0：仅缓存加密评论 |

---

## 6. 日志数据结构

### 6.1 日志格式

**日志格式**:
```
[YYYY-MM-DD HH:MM:SS] [LEVEL] [MODULE:LINE] MESSAGE
```

**V2.0 示例**:
```
[2025-01-02 10:30:45] [INFO] [monitor.py:45] 成功识别歌曲: 浪人情歌 - 伍佰
[2025-01-02 10:30:46] [INFO] [api_client.py:78] 获取评论成功: 20条（加密）
[2025-01-02 10:30:47] [DEBUG] [crypto/manager.py:156] 开始解密评论内容
[2025-01-02 10:30:48] [INFO] [crypto/manager.py:234] 解密完成，显示真实评论
[2025-01-02 10:30:49] [DEBUG] [comment_widget.py:123] 切换到第 2 条评论（智能间隔：5秒）
```

### 6.2 日志级别

| 级别 | 说明 | 使用场景 |
|------|------|----------|
| DEBUG | 调试信息 | 详细执行流程（包括加密解密过程） |
| INFO | 正常信息 | 关键操作记录 |
| WARNING | 警告信息 | 可恢复的异常（如解密失败） |
| ERROR | 错误信息 | 需要关注的错误 |
| CRITICAL | 严重错误 | 程序无法继续 |

### 6.3 日志文件

**文件位置**: `logs/music-comment-YYYY-MM-DD.log`

**文件轮转**:
- 每天一个文件
- 保留最近 30 天
- 单文件最大 10MB

---

## 7. 数据流转 (V2.0 更新)

### 7.1 数据流图 (V2.0)

```
┌─────────────────────────────────────────┐
│  1. 窗口标题读取                          │
│     Input: 窗口标题                       │
│     Output: (song_name, artist_name)    │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  2. 搜索 song_id                        │
│     Input: (song_name, artist_name)     │
│     Output: song_id                    │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  3. 获取加密的热门评论                    │
│     Input: song_id                     │
│     Output: List[EncryptedComment]      │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  4. Crypto模块解密                      │
│     Input: 加密的评论数据                │
│     Output: 真实评论 + 验证签名         │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  5. 获取歌曲详情                         │
│     Input: song_id                     │
│     Output: SongInfo                   │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  6. 增强版评论轮播                       │
│     Input: SongInfo + 真实评论          │
│     Output: 界面更新（支持暂停/记忆）   │
└─────────────────────────────────────────┘
```

### 7.2 数据转换 (V2.0 增强)

**窗口标题 → 歌曲信息** (无变化):
```python
# Input
window_title = "浪人情歌 - 伍佰"

# Parse
parts = window_title.split(" - ")
song_name = parts[0]  # "浪人情歌"
artist_name = parts[1]  # "伍佰"

# Output
song_info = SongInfo(
    song_id="",  # 待搜索
    name=song_name,
    artist=artist_name
)
```

**V2.0 API 响应 → Comment** (加密解密):
```python
# Input (API Response - 加密)
api_response = {
    "hotComments": [
        {
            "content": "U2FsdGVkX1+eB7C3p9K6wJXqR6L9mN3QZ4T8V2Y8WqE=",
            "encryptedKey": "U2FsdGVkX1/abc123...",
            "signature": "SHA256:abc123...",
            "user": {"nickname": "用户A"},
            "likedCount": 123
        }
    ]
}

# V2.0 解密流程
from crypto.crypto_manager import CryptoManager

# 1. 初始化加密管理器
crypto_manager = CryptoManager()

# 2. 解密每条评论
comments = []
for item in api_response["hotComments"]:
    try:
        # 解密评论内容
        decrypted_content = crypto_manager.decrypt_comment(item)

        # 创建评论对象
        comment = Comment(
            content=decrypted_content,  # 真实评论内容
            user=item["user"]["nickname"],
            likes=item["likedCount"]
        )
        comments.append(comment)

    except Exception as e:
        # 解密失败处理
        comment = Comment(
            content="[解密失败]",
            user=item["user"]["nickname"],
            likes=item["likedCount"]
        )
        comments.append(comment)

# Output
List[Comment]  # 包含解密后的真实评论
```

---

## 8. 数据验证

### 8.1 输入验证

**窗口标题验证**:
```python
def validate_window_title(title: str) -> bool:
    """验证窗口标题"""
    if not title:
        return False
    if not isinstance(title, str):
        return False
    if len(title) > 200:
        return False
    if ' - ' not in title:
        return False
    return True
```

**song_id 验证**:
```python
def validate_song_id(song_id: str) -> bool:
    """验证 song_id"""
    if not song_id:
        return False
    if not song_id.isdigit():
        return False
    return True
```

### 8.2 输出验证 (V2.0 增强版)

**SongInfo 验证** (无变化):
```python
def validate_song_info(song: SongInfo) -> bool:
    """验证歌曲信息"""
    if not song.song_id:
        return False
    if not song.name or not song.artist:
        return False
    if song.duration < 0:
        return False
    return True
```

**Comment 验证 (V2.0 增强版)**:
```python
def validate_comment(comment: Comment) -> bool:
    """V2.0: 验证评论数据（支持加密）"""
    # 基础验证
    if not comment.content:
        return False
    if not comment.user:
        return False
    if comment.likes < 0:
        return False

    # V2.0 加密字段验证
    if comment.is_encrypted():
        if not comment.encrypted_content:
            return False
        if not comment.encrypted_key:
            return False
        if not comment.signature:
            return False

    return True
```

**加密数据验证 (V2.0 新增)**:
```python
def validate_encrypted_data(data: dict) -> bool:
    """V2.0: 验证加密数据格式"""
    required_fields = ["content", "encryptedKey", "signature"]
    return all(field in data for field in required_fields)
```

---

## 9. 数据字典总结 (V2.0 更新)

### 9.1 核心数据结构

| 名称 | 用途 | 存储位置 | 生命周期 | V2.0变更 |
|------|------|----------|----------|----------|
| SongInfo | 歌曲信息 | 内存 | 当前歌曲 | 无变化 |
| Comment | 评论信息 | 内存 | 当前歌曲 | 新增加密字段 |
| AppConfig | 应用配置 | 文件 | 持久化 | 新增加密/轮播配置 |
| 缓存数据 | 性能优化 | 内存 | TTL | 分离加密/解密缓存 |
| **CryptoKey** | **加密密钥** | **文件** | **持久化** | **V2.0新增** |
| **EncryptedComment** | **加密评论** | **内存/文件** | **TTL** | **V2.0新增** |

### 9.2 V2.0 数据大小估算

| 数据类型 | 单条大小 | 最大数量 | 总大小 | V2.0变更 |
|----------|----------|----------|--------|----------|
| SongInfo | ~500 bytes | 1 | 500 bytes | 无变化 |
| Comment | ~500 bytes | 20 | 10 KB | 新增加密字段 |
| AppConfig | ~2 KB | 1 | 2 KB | 新增配置项 |
| 缓存加密评论 | ~20 KB | 50 | 1 MB | 新增缓存类型 |
| 缓存解密评论 | ~10 KB | 20 | 200 KB | 新增缓存类型 |
| **总计** | - | - | **~1.7 MB** | **大幅增加** |

### 9.3 V2.0 存储增长说明

- **加密评论**：每个评论从 ~300 bytes 增加到 ~1KB（加密数据）
- **密钥存储**：新增 RSA 密钥对（~1KB）
- **配置文件**：从 ~1KB 增加到 ~2KB（新增加密和轮播配置）
- **缓存优化**：分离加密/解密缓存，支持更精确的TTL控制

---

## 10. 数据安全 (V2.0 增强)

### 10.1 数据隐私 (V2.0 新增保护)

**不收集的数据**:
- ❌ 用户账号信息
- ❌ 听歌历史记录
- ❌ 个人身份信息
- ❌ 使用行为数据
- ❌ 加密密钥（本地存储，不上传）

**新增保护措施**:
- ✅ **端到端加密**：评论内容在客户端加密
- ✅ **密钥安全**：RSA密钥仅存储在本地
- ✅ **数据签名**：防止数据篡改
- ✅ **临时解密**：评论仅在内存中临时解密

### 10.2 数据保护 (V2.0 增强)

**保护措施**:
1. **本地存储**: 所有数据仅存储在本地
2. **不上传**: 不向任何远程服务器上传数据
3. **加密存储**: 敏感数据加密存储
4. **密钥管理**: RSA密钥对安全存储
5. **定期清理**: 日志文件自动轮转，定期删除
6. **内存保护**: 解密后的评论内容不持久化

---

## 11. 附录

### 11.1 V2.0 新增数据类型

| 类型 | 说明 | 示例 |
|------|------|------|
| str | 字符串 | "浪人情歌" |
| bytes | 字节（加密用） | b'encrypted_data' |
| **Dict[str, str]** | **加密数据字典** | **{"content": "...", "key": "..."}** |

### 11.2 V2.0 新增字段约束

| 约束 | 说明 | 示例 |
|------|------|------|
| 加密 | 必须加密的数据 | encrypted_content |
| 签名 | 数据完整性验证 | signature |
| 长度(加密) | 加密数据长度限制 | encrypted_content ≤ 2048 |

### 11.3 V2.0 新增枚举值

**评论显示模式**:
```python
DISPLAY_MODES = ["real", "encrypted", "mixed"]  # 真实/加密/混合
```

**加密算法**:
```python
ENCRYPTION_ALGORITHMS = ["AES+RSA", "RSA-only"]  # 加密算法
```

**轮播控制**:
```python
ROTATION_CONTROLS = ["auto", "manual", "both"]  # 轮播控制方式
```

---

*V2.0 版本更新总结*:
- **安全性提升**: 实现AES+RSA混合加密算法
- **功能增强**: 新增真实评论展示、智能轮播
- **架构升级**: 新增crypto模块，分离加密解密逻辑
- **配置扩展**: 新增加密和轮播相关配置
- **性能优化**: 支持加密/解密分离缓存
- **用户体验**: 支持暂停/继续轮播、位置记忆

---

**文档结束**
