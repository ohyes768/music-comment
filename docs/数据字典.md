# ç½‘æ˜“äº‘éŸ³ä¹è¯„è®ºæ¡Œé¢åº”ç”¨ - æ•°æ®å­—å…¸ (V2.0)

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¥æœŸ**: 2024-12-30
**æœ€åæ›´æ–°**: 2025-01-02

---

## 1. æ•°æ®æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨**å†…å­˜å­˜å‚¨ + æ–‡ä»¶å­˜å‚¨**çš„æ–¹å¼ï¼Œä¸ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“ã€‚

| å­˜å‚¨ç±»å‹ | ç”¨é€” | ä½ç½® |
|----------|------|------|
| å†…å­˜ç¼“å­˜ | ä¸´æ—¶æ•°æ®ã€ç¼“å­˜ | Python è¿›ç¨‹å†…å­˜ |
| é…ç½®æ–‡ä»¶ | ç”¨æˆ·é…ç½® | `~/.music-comment/config.json` |
| æ—¥å¿—æ–‡ä»¶ | è¿è¡Œæ—¥å¿— | `logs/music-comment.log` |
| **åŠ å¯†å¯†é’¥** | V2.0æ–°å¢ï¼šRSAå¯†é’¥å¯¹ | `~/.music-comment/keys/` |
| **åŠ å¯†æ•°æ®** | V2.0æ–°å¢ï¼šåŠ å¯†çš„è¯„è®ºå†…å®¹ | `~/.music-comment/cache/encrypted_comments.json` |

---

## 2. æ•°æ®æ¨¡å‹

### 2.1 æ•°æ®æ¨¡å‹æ¦‚è§ˆ (V2.0 æ›´æ–°)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SongInfo (æ­Œæ›²ä¿¡æ¯)            â”‚
â”‚  song_id: str                           â”‚
â”‚  name: str                              â”‚
â”‚  artist: str                            â”‚
â”‚  album: str                             â”‚
â”‚  genres: List[str]                      â”‚
â”‚  duration: int                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Comment (è¯„è®º) V2.0             â”‚
â”‚  content: str                           â”‚
â”‚  user: str                              â”‚
â”‚  likes: int                             â”‚
â”‚  time: str                              â”‚
â”‚  encrypted_content: str     (æ–°å¢)      â”‚
â”‚  encrypted_key: str         (æ–°å¢)      â”‚
â”‚  signature: str             (æ–°å¢)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CryptoKey (åŠ å¯†å¯†é’¥) V2.0æ–°å¢       â”‚
â”‚  key_type: str (RSA/AES)               â”‚
â”‚  key_data: str                          â”‚
â”‚  key_size: int                          â”‚
â”‚  created_at: datetime                   â”‚
â”‚  expires_at: datetime                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AppConfig (åº”ç”¨é…ç½®) V2.0å¢å¼º        â”‚
â”‚  show_real_comments: bool               â”‚
â”‚  rotation_settings: dict                â”‚
â”‚  encryption_config: dict                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 SongInfoï¼ˆæ­Œæ›²ä¿¡æ¯ï¼‰

**èŒè´£**: å­˜å‚¨æ­Œæ›²çš„åŸºæœ¬ä¿¡æ¯

**å­—æ®µå®šä¹‰**:

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|--------|------|------|
| song_id | str | 20 | æ˜¯ | - | ç½‘æ˜“äº‘æ­Œæ›²ID | "347230" |
| name | str | 200 | æ˜¯ | - | æ­Œæ›²åç§° | "æµªäººæƒ…æ­Œ" |
| artist | str | 100 | æ˜¯ | - | æ­Œæ‰‹åç§° | "ä¼ä½°" |
| album | str | 200 | å¦ | "" | ä¸“è¾‘åç§° | "çˆ±æƒ…çš„å°½å¤´" |
| genres | List[str] | - | å¦ | [] | **éŸ³ä¹é£æ ¼åˆ—è¡¨ï¼ˆä»APIçš„songTagå­—æ®µè·å–ï¼‰** | ["æµè¡Œ", "æ‘‡æ»š"] |
| duration | int | - | å¦ | 0 | æ—¶é•¿ï¼ˆç§’ï¼‰ | 283 |

**ğŸ”‘ å…³äº genres å­—æ®µ**:
- **æ•°æ®æ¥æº**: ä¼˜å…ˆä»ç½‘æ˜“äº‘APIçš„ `songTag` å­—æ®µè·å–ï¼ˆå®˜æ–¹æ›²é£æ ‡ç­¾ï¼‰
- **å¤‡é€‰æ–¹æ¡ˆ**: å¦‚æœ `songTag` ä¸ºç©ºï¼Œä½¿ç”¨ `alias` å­—æ®µï¼ˆæ­Œæ›²åˆ«åï¼‰
- **æœ€ç»ˆé™çº§**: å¦‚æœéƒ½ä¸ºç©ºï¼Œä½¿ç”¨ `["æœªçŸ¥é£æ ¼"]`
- **æ˜¾ç¤ºç­–ç•¥**: æœ€å¤šæ˜¾ç¤º3ä¸ªæ ‡ç­¾ï¼Œç”¨ " / " åˆ†éš”
- **å‚è€ƒæ–‡æ¡£**: [éŸ³ä¹é£æ ¼è·å–æ–¹æ¡ˆè°ƒç ”](../discuss/2024-12-30_éŸ³ä¹é£æ ¼è·å–æ–¹æ¡ˆè°ƒç ”.md)

**æ•°æ®ç¤ºä¾‹**:
```json
{
  "song_id": "347230",
  "name": "æµªäººæƒ…æ­Œ",
  "artist": "ä¼ä½°",
  "album": "çˆ±æƒ…çš„å°½å¤´",
  "genres": ["æµè¡Œ", "æ‘‡æ»š", "æ°‘è°£"],
  "duration": 283
}
```

**ä»£ç å®šä¹‰**:
```python
from dataclasses import dataclass
from typing import List

@dataclass
class SongInfo:
    """æ­Œæ›²ä¿¡æ¯æ¨¡å‹"""
    song_id: str
    name: str
    artist: str
    album: str = ""
    genres: List[str] = None
    duration: int = 0

    def __post_init__(self):
        if self.genres is None:
            self.genres = []

    def get_genres_str(self) -> str:
        """è·å–é£æ ¼å­—ç¬¦ä¸²ï¼ˆæœ€å¤šæ˜¾ç¤º3ä¸ªï¼‰"""
        if not self.genres:
            return "æœªçŸ¥é£æ ¼"
        # æœ€å¤šæ˜¾ç¤º3ä¸ªæ ‡ç­¾
        display_genres = self.genres[:3]
        return " / ".join(display_genres)
```

**API æ˜ å°„ç¤ºä¾‹**:
```python
def map_song_info_from_api(song_data: dict) -> SongInfo:
    """ä»APIå“åº”æ˜ å°„åˆ°SongInfoï¼ˆæ™ºèƒ½é™çº§ï¼‰"""
    # ä¼˜å…ˆä½¿ç”¨ songTagï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨ aliasï¼Œæœ€åä½¿ç”¨é»˜è®¤å€¼
    genres = song_data.get("songTag", [])
    if not genres:
        alias = song_data.get("alias", [])
        genres = alias if alias else ["æœªçŸ¥é£æ ¼"]

    return SongInfo(
        song_id=str(song_data['id']),
        name=song_data['name'],
        artist=song_data['artists'][0]['name'],
        album=song_data.get('album', {}).get('name', ''),
        genres=genres,
        duration=song_data.get('duration', 0) // 1000
    )
```

---

### 2.3 Commentï¼ˆè¯„è®ºï¼‰V2.0å¢å¼º

**èŒè´£**: å­˜å‚¨è¯„è®ºä¿¡æ¯ï¼Œæ–°å¢åŠ å¯†å­—æ®µæ”¯æŒ

**å­—æ®µå®šä¹‰**:

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|--------|------|------|
| content | str | 1000 | æ˜¯ | - | è¯„è®ºå†…å®¹ï¼ˆV2.0å¯åŠ å¯†ï¼‰ | "è¿™é¦–æ­Œå¾ˆæ„ŸåŠ¨..." |
| encrypted_content | str | 2048 | å¦ | "" | V2.0æ–°å¢ï¼šAESåŠ å¯†çš„è¯„è®ºå†…å®¹ | "U2FsdGVkX1+..." |
| user | str | 100 | æ˜¯ | - | ç”¨æˆ·æ˜µç§° | "éŸ³ä¹çˆ±å¥½è€…" |
| likes | int | - | æ˜¯ | 0 | ç‚¹èµæ•° | 1234 |
| time | str | 50 | å¦ | "" | è¯„è®ºæ—¶é—´ | "1489154546341" |
| encrypted_key | str | 512 | å¦ | "" | V2.0æ–°å¢ï¼šRSAåŠ å¯†çš„AESå¯†é’¥ | "U2FsdGVkX1/..." |
| signature | str | 128 | å¦ | "" | V2.0æ–°å¢ï¼šSHA256ç­¾å | "SHA256:abc123..." |
| display_mode | str | 20 | å¦ | "real" | V2.0æ–°å¢ï¼šæ˜¾ç¤ºæ¨¡å¼ | "real"\|"encrypted"\|"mixed" |

**V2.0 æ•°æ®ç¤ºä¾‹**ï¼š
```json
{
  "content": "è¿™é¦–æ­Œæ¯æ¬¡å¬éƒ½å¾ˆæ„ŸåŠ¨ï¼Œå°¤å…¶æ˜¯å‰å¥å“èµ·çš„æ—¶å€™...",
  "encrypted_content": "U2FsdGVkX1+eB7C3p9K6wJXqR6L9mN3QZ4T8V2Y8WqE=",
  "user": "ç”¨æˆ·æ˜µç§°",
  "likes": 12345,
  "time": "1489154546341",
  "encrypted_key": "U2FsdGVkX1/abc123def456...",
  "signature": "SHA256:abc123def4567890...",
  "display_mode": "real"
}
```

**V2.0 åŠ å¯†å­—æ®µè¯´æ˜**ï¼š
- `encrypted_content`: ä½¿ç”¨AESåŠ å¯†çš„è¯„è®ºå†…å®¹ï¼Œç¡®ä¿ä¼ è¾“å®‰å…¨
- `encrypted_key`: ä½¿ç”¨RSAåŠ å¯†çš„AESå¯†é’¥ï¼Œç”¨äºè§£å¯†è¯„è®ºå†…å®¹
- `signature`: SHA256æ•°å­—ç­¾åï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œé˜²ç¯¡æ”¹
- `display_mode`: æ§åˆ¶è¯„è®ºæ˜¾ç¤ºæ¨¡å¼ï¼ˆçœŸå®/åŠ å¯†/æ··åˆï¼‰

**V2.0 ä»£ç å®šä¹‰**ï¼š
```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class Comment:
    """V2.0 å¢å¼ºç‰ˆè¯„è®ºä¿¡æ¯æ¨¡å‹"""
    content: str
    user: str
    likes: int
    time: str = ""

    # V2.0 æ–°å¢åŠ å¯†å­—æ®µ
    encrypted_content: str = ""
    encrypted_key: str = ""
    signature: str = ""
    display_mode: str = "real"  # "real", "encrypted", "mixed"

    def is_encrypted(self) -> bool:
        """æ£€æŸ¥è¯„è®ºæ˜¯å¦åŠ å¯†"""
        return bool(self.encrypted_content and self.encrypted_key)

    def get_display_content(self) -> str:
        """è·å–æ˜¾ç¤ºå†…å®¹ï¼ˆæ ¹æ®display_modeï¼‰"""
        if self.display_mode == "encrypted":
            return self.encrypted_content
        elif self.display_mode == "mixed":
            # éšæœºè¿”å›çœŸå®æˆ–åŠ å¯†å†…å®¹
            import random
            return random.choice([self.content, self.encrypted_content])
        else:  # "real"
            return self.content

    def verify_signature(self, public_key) -> bool:
        """V2.0æ–°å¢ï¼šéªŒè¯æ•°æ®ç­¾å"""
        # éªŒè¯é€»è¾‘å®ç°
        pass
```

---

### 2.4 AppConfigï¼ˆåº”ç”¨é…ç½®ï¼‰V2.0å¢å¼º

**èŒè´£**: å­˜å‚¨åº”ç”¨é…ç½®ä¿¡æ¯ï¼ŒV2.0æ–°å¢åŠ å¯†å’Œè½®æ’­å¢å¼ºé…ç½®

**å­—æ®µå®šä¹‰**:

| å­—æ®µå | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| **çª—å£é…ç½®** | | | |
| window_width | int | 320 | çª—å£å®½åº¦ï¼ˆåƒç´ ï¼‰ |
| window_height | int | 180 | çª—å£é«˜åº¦ï¼ˆåƒç´ ï¼‰ |
| window_opacity | float | 0.85 | çª—å£é€æ˜åº¦ï¼ˆ0-1ï¼‰ |
| **è¯„è®ºè½®æ’­é…ç½®ï¼ˆV2.0å¢å¼ºï¼‰** | | | |
| rotation_interval | int | 5000 | è¯„è®ºè½®æ’­é—´éš”ï¼ˆæ¯«ç§’ï¼‰ |
| rotation_animation_duration | int | 500 | åŠ¨ç”»æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ |
| rotation_auto_pause | bool | True | V2.0æ–°å¢ï¼šè‡ªåŠ¨æš‚åœï¼ˆé¼ æ ‡æ‚¬åœï¼‰ |
| rotation_manual_pause | bool | True | V2.0æ–°å¢ï¼šå…è®¸æ‰‹åŠ¨æš‚åœ |
| rotation_smart_interval | bool | True | V2.0æ–°å¢ï¼šæ™ºèƒ½é—´éš”ï¼ˆæ ¹æ®è¯„è®ºé•¿åº¦ï¼‰ |
| rotation_min_interval | int | 3000 | V2.0æ–°å¢ï¼šæœ€å°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ |
| rotation_max_interval | int | 10000 | V2.0æ–°å¢ï¼šæœ€å¤§é—´éš”ï¼ˆæ¯«ç§’ï¼‰ |
| rotation_memory_position | bool | True | V2.0æ–°å¢ï¼šè®°å¿†ä½ç½® |
| **è¯„è®ºæ˜¾ç¤ºé…ç½®ï¼ˆV2.0æ–°å¢ï¼‰** | | | |
| show_real_comments | bool | True | V2.0æ–°å¢ï¼šæ˜¾ç¤ºçœŸå®è¯„è®º |
| show_encrypted_comments | bool | False | V2.0æ–°å¢ï¼šæ˜¾ç¤ºåŠ å¯†è¯„è®ºï¼ˆè°ƒè¯•ç”¨ï¼‰ |
| decryption_timeout | int | 10000 | V2.0æ–°å¢ï¼šè§£å¯†è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ |
| **åŠ å¯†é…ç½®ï¼ˆV2.0æ–°å¢ï¼‰** | | | |
| encryption_enabled | bool | True | V2.0æ–°å¢ï¼šå¯ç”¨åŠ å¯† |
| encryption_algorithm | str | "AES+RSA" | V2.0æ–°å¢ï¼šåŠ å¯†ç®—æ³• |
| aes_key_size | int | 256 | V2.0æ–°å¢ï¼šAESå¯†é’¥é•¿åº¦ |
| rsa_key_size | int | 2048 | V2.0æ–°å¢ï¼šRSAå¯†é’¥é•¿åº¦ |
| **APIé…ç½®** | | | |
| api_base_url | str | "http://localhost:3000" | API æœåŠ¡åœ°å€ |
| api_timeout | int | 10 | API è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰ |
| max_retries | int | 3 | æœ€å¤§é‡è¯•æ¬¡æ•° |
| **ç¼“å­˜é…ç½®** | | | |
| cache_size | int | 50 | ç¼“å­˜å¤§å° |
| comment_cache_time | int | 3600 | è¯„è®ºç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ |

**V2.0 æ•°æ®ç¤ºä¾‹**:
```json
{
  "window_width": 320,
  "window_height": 180,
  "window_opacity": 0.85,
  "rotation_interval": 5000,
  "rotation_animation_duration": 500,
  "rotation_auto_pause": true,
  "rotation_manual_pause": true,
  "rotation_smart_interval": true,
  "rotation_min_interval": 3000,
  "rotation_max_interval": 10000,
  "rotation_memory_position": true,
  "show_real_comments": true,
  "show_encrypted_comments": false,
  "decryption_timeout": 10000,
  "encryption_enabled": true,
  "encryption_algorithm": "AES+RSA",
  "aes_key_size": 256,
  "rsa_key_size": 2048,
  "api_base_url": "http://localhost:3000",
  "api_timeout": 10,
  "max_retries": 3,
  "cache_size": 50,
  "comment_cache_time": 3600
}
```

---

## 3. V2.0 æ–°å¢æ•°æ®æ¨¡å‹

### 3.1 CryptoKeyï¼ˆåŠ å¯†å¯†é’¥ï¼‰

**èŒè´£**: V2.0æ–°å¢ï¼Œç®¡ç†åŠ å¯†å¯†é’¥å¯¹

**å­—æ®µå®šä¹‰**:

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|--------|------|------|
| key_type | str | 20 | æ˜¯ | - | å¯†é’¥ç±»å‹ï¼ˆRSA/AESï¼‰ | "RSA" |
| key_data | str | 4096 | æ˜¯ | - | å¯†é’¥æ•°æ®ï¼ˆBase64ç¼–ç ï¼‰ | "-----BEGIN RSA..." |
| key_size | int | - | æ˜¯ | - | å¯†é’¥é•¿åº¦ï¼ˆä½ï¼‰ | 2048 |
| created_at | datetime | - | å¦ | - | åˆ›å»ºæ—¶é—´ | "2025-01-02T10:30:00" |
| expires_at | datetime | - | å¦ | - | è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰ | "2025-12-31T23:59:59" |
| algorithm | str | 50 | å¦ | - | åŠ å¯†ç®—æ³• | "AES-256-CBC" |

**æ•°æ®ç¤ºä¾‹**:
```json
{
  "key_type": "RSA",
  "key_data": "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...\n-----END RSA PRIVATE KEY-----",
  "key_size": 2048,
  "created_at": "2025-01-02T10:30:00Z",
  "expires_at": "2025-12-31T23:59:59Z",
  "algorithm": "RSA-2048-OAEP"
}
```

**å­˜å‚¨ä½ç½®**: `~/.music-comment/keys/`
- `private_key.pem`: RSAç§é’¥
- `public_key.pem`: RSAå…¬é’¥
- `key_metadata.json`: å¯†é’¥å…ƒæ•°æ®

### 3.2 EncryptedCommentï¼ˆåŠ å¯†è¯„è®ºï¼‰

**èŒè´£**: V2.0æ–°å¢ï¼Œå­˜å‚¨åŠ å¯†çš„è¯„è®ºæ•°æ®

**å­—æ®µå®šä¹‰**:

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|--------|------|------|
| song_id | str | 20 | æ˜¯ | - | æ­Œæ›²ID | "347230" |
| encrypted_content | str | 2048 | æ˜¯ | - | AESåŠ å¯†çš„è¯„è®ºå†…å®¹ | "U2FsdGVkX1+..." |
| encrypted_key | str | 512 | æ˜¯ | - | RSAåŠ å¯†çš„AESå¯†é’¥ | "U2FsdGVkX1/..." |
| signature | str | 128 | æ˜¯ | - | SHA256ç­¾å | "SHA256:abc123..." |
| timestamp | datetime | - | æ˜¯ | - | åŠ å¯†æ—¶é—´ | "2025-01-02T10:30:00" |
| user_info | dict | - | å¦ | - | ç”¨æˆ·ä¿¡æ¯ï¼ˆè„±æ•ï¼‰ | {"nickname": "ç”¨æˆ·"} |

**æ•°æ®ç¤ºä¾‹**:
```json
{
  "song_id": "347230",
  "encrypted_content": "U2FsdGVkX1+eB7C3p9K6wJXqR6L9mN3QZ4T8V2Y8WqE=",
  "encrypted_key": "U2FsdGVkX1/abc123def456...",
  "signature": "SHA256:abc123def4567890...",
  "timestamp": "2025-01-02T10:30:00Z",
  "user_info": {
    "nickname": "éŸ³ä¹çˆ±å¥½è€…",
    "avatar_url": "https://p1.music.126.net/..."
  }
}
```

**å­˜å‚¨ä½ç½®**: `~/.music-comment/cache/encrypted_comments.json`

---

## 4. ç¼“å­˜æ•°æ®ç»“æ„

### 4.1 å†…å­˜ç¼“å­˜

**ç¼“å­˜ç±»å‹**: LRU Cache (Least Recently Used)

**ç¼“å­˜ç»“æ„**:
```python
# æœç´¢ç¼“å­˜
search_cache = {
    (song_name, artist_name): song_id
}

# æ­Œæ›²è¯¦æƒ…ç¼“å­˜
song_cache = {
    song_id: SongInfo
}

# è¯„è®ºç¼“å­˜ï¼ˆV2.0åŠ å¯†ï¼‰
comment_cache = {
    song_id: {
        'encrypted_comments': list,  # åŠ å¯†çš„è¯„è®ºåˆ—è¡¨
        'timestamp': float,          # ç¼“å­˜æ—¶é—´æˆ³
        'decrypted_comments': list  # è§£å¯†åçš„è¯„è®ºï¼ˆå¯é€‰ï¼‰
    }
}

# åŠ å¯†å¯†é’¥ç¼“å­˜ï¼ˆV2.0æ–°å¢ï¼‰
crypto_cache = {
    'rsa_public_key': str,      # RSAå…¬é’¥
    'rsa_private_key': str,     # RSAç§é’¥
    'last_generated': float     # æœ€åç”Ÿæˆæ—¶é—´
}
```

**V2.0 ç¼“å­˜é…ç½®**:

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|---|------|
| maxsize | 50 | æœ€å¤§ç¼“å­˜æ¡ç›®æ•° |
| ttl (song) | 86400 | æ­Œæ›²è¯¦æƒ…ç¼“å­˜æ—¶é—´ï¼ˆ24å°æ—¶ï¼‰ |
| ttl (encrypted_comment) | 3600 | V2.0ï¼šåŠ å¯†è¯„è®ºç¼“å­˜æ—¶é—´ï¼ˆ1å°æ—¶ï¼‰ |
| ttl (decrypted_comment) | 1800 | V2.0ï¼šè§£å¯†è¯„è®ºç¼“å­˜æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰ |
| ttl (crypto_key) | 86400 | V2.0ï¼šåŠ å¯†å¯†é’¥ç¼“å­˜æ—¶é—´ï¼ˆ24å°æ—¶ï¼‰ |
| decryption_workers | 2 | V2.0ï¼šè§£å¯†çº¿ç¨‹æ•° |
| cache_encrypted_only | true | V2.0ï¼šä»…ç¼“å­˜åŠ å¯†è¯„è®ºï¼ˆèŠ‚çœå†…å­˜ï¼‰ |

**V2.0 ä»£ç å®ç°**:
```python
from functools import lru_cache
import time
from typing import Dict, List, Optional

class CacheManager:
    """V2.0 å¢å¼ºç‰ˆç¼“å­˜ç®¡ç†å™¨"""

    def __init__(self):
        # åŸºç¡€ç¼“å­˜
        self.search_cache = {}  # æœç´¢ç¼“å­˜
        self.song_cache = {}    # æ­Œæ›²è¯¦æƒ…ç¼“å­˜

        # V2.0 åŠ å¯†è¯„è®ºç¼“å­˜
        self.encrypted_comment_cache = {}  # åŠ å¯†è¯„è®ºç¼“å­˜
        self.decrypted_comment_cache = {}  # è§£å¯†è¯„è®ºç¼“å­˜ï¼ˆå¸¦TTLï¼‰

        # V2.0 åŠ å¯†å¯†é’¥ç¼“å­˜
        self.crypto_key_cache = {
            'public_key': None,
            'private_key': None,
            'last_generated': 0
        }

    @lru_cache(maxsize=50)
    def get_song_detail(self, song_id: str) -> SongInfo:
        """è·å–æ­Œæ›²è¯¦æƒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        # API è°ƒç”¨
        pass

    def get_encrypted_comments(self, song_id: str) -> List[dict]:
        """V2.0ï¼šè·å–åŠ å¯†è¯„è®º"""
        if song_id in self.encrypted_comment_cache:
            data, timestamp = self.encrypted_comment_cache[song_id]
            if time.time() - timestamp < 3600:  # 1å°æ—¶
                return data
        # API è°ƒç”¨
        pass

    def get_decrypted_comments(self, song_id: str) -> Optional[List[Comment]]:
        """V2.0ï¼šè·å–è§£å¯†è¯„è®ºï¼ˆå¸¦TTLï¼‰"""
        if song_id in self.decrypted_comment_cache:
            comments, timestamp = self.decrypted_comment_cache[song_id]
            if time.time() - timestamp < 1800:  # 30åˆ†é’Ÿ
                return comments
        return None

    def cache_decrypted_comments(self, song_id: str, comments: List[Comment]):
        """V2.0ï¼šç¼“å­˜è§£å¯†è¯„è®º"""
        self.decrypted_comment_cache[song_id] = (comments, time.time())

    def get_crypto_keys(self) -> tuple:
        """V2.0ï¼šè·å–åŠ å¯†å¯†é’¥"""
        # æ£€æŸ¥å¯†é’¥æ˜¯å¦è¿‡æœŸ
        if time.time() - self.crypto_key_cache['last_generated'] > 86400:
            # é‡æ–°ç”Ÿæˆå¯†é’¥
            self._generate_new_keys()

        return (
            self.crypto_key_cache['public_key'],
            self.crypto_key_cache['private_key']
        )

    def _generate_new_keys(self):
        """V2.0ï¼šç”Ÿæˆæ–°çš„RSAå¯†é’¥å¯¹"""
        from Crypto.PublicKey import RSA

        key = RSA.generate(2048)
        self.crypto_key_cache['public_key'] = key.publickey().export_key().decode()
        self.crypto_key_cache['private_key'] = key.export_key().decode()
        self.crypto_key_cache['last_generated'] = time.time()

    def clear_decrypted_cache(self):
        """V2.0ï¼šæ¸…é™¤è§£å¯†ç¼“å­˜ï¼ˆèŠ‚çœå†…å­˜ï¼‰"""
        self.decrypted_comment_cache.clear()
```

---

## 5. é…ç½®æ–‡ä»¶ç»“æ„

### 4.1 æ–‡ä»¶ä½ç½®

```
~/.music-comment/
â”œâ”€â”€ config.json         # é…ç½®æ–‡ä»¶
â””â”€â”€ cache/              # ç¼“å­˜ç›®å½•ï¼ˆå¯é€‰ï¼‰
```

### 4.2 é…ç½®æ–‡ä»¶æ ¼å¼

**æ–‡ä»¶è·¯å¾„**: `~/.music-comment/config.json`

**æ–‡ä»¶å†…å®¹**:
```json
{
  "window": {
    "width": 320,
    "height": 180,
    "opacity": 0.85,
    "position": {
      "x": 100,
      "y": 100
    }
  },
  "rotation": {
    "interval": 5000,
    "animation_duration": 500
  },
  "api": {
    "base_url": "http://localhost:3000",
    "timeout": 10,
    "max_retries": 3
  },
  "cache": {
    "size": 50,
    "comment_ttl": 3600
  }
}
```

**å­—æ®µè¯´æ˜**:

| è·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| window.width | int | çª—å£å®½åº¦ |
| window.height | int | çª—å£é«˜åº¦ |
| window.opacity | float | çª—å£é€æ˜åº¦ |
| window.position.x | int | çª—å£Xåæ ‡ |
| window.position.y | int | çª—å£Yåæ ‡ |
| rotation.interval | int | è½®æ’­é—´éš”ï¼ˆæ¯«ç§’ï¼‰ |
| rotation.animation_duration | int | åŠ¨ç”»æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ |
| api.base_url | string | APIæœåŠ¡åœ°å€ |
| api.timeout | int | è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰ |
| api.max_retries | int | æœ€å¤§é‡è¯•æ¬¡æ•° |
| cache.size | int | ç¼“å­˜å¤§å° |
| cache.comment_ttl | int | è¯„è®ºç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ |

---

## 5. æ—¥å¿—æ•°æ®ç»“æ„

### 5.1 æ—¥å¿—æ ¼å¼

**æ—¥å¿—æ ¼å¼**:
```
[YYYY-MM-DD HH:MM:SS] [LEVEL] [MODULE:LINE] MESSAGE
```

**ç¤ºä¾‹**:
```
[2024-12-30 10:30:45] [INFO] [monitor.py:45] æˆåŠŸè¯†åˆ«æ­Œæ›²: æµªäººæƒ…æ­Œ - ä¼ä½°
[2024-12-30 10:30:46] [INFO] [api_client.py:78] è·å–è¯„è®ºæˆåŠŸ: 20æ¡
[2024-12-30 10:30:47] [DEBUG] [comment_widget.py:123] åˆ‡æ¢åˆ°ç¬¬ 2 æ¡è¯„è®º
```

### 5.2 æ—¥å¿—çº§åˆ«

| çº§åˆ« | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| DEBUG | è°ƒè¯•ä¿¡æ¯ | è¯¦ç»†æ‰§è¡Œæµç¨‹ |
| INFO | æ­£å¸¸ä¿¡æ¯ | å…³é”®æ“ä½œè®°å½• |
| WARNING | è­¦å‘Šä¿¡æ¯ | å¯æ¢å¤çš„å¼‚å¸¸ |
| ERROR | é”™è¯¯ä¿¡æ¯ | éœ€è¦å…³æ³¨çš„é”™è¯¯ |
| CRITICAL | ä¸¥é‡é”™è¯¯ | ç¨‹åºæ— æ³•ç»§ç»­ |

### 5.3 æ—¥å¿—æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**: `logs/music-comment-YYYY-MM-DD.log`

**æ–‡ä»¶è½®è½¬**:
- æ¯å¤©ä¸€ä¸ªæ–‡ä»¶
- ä¿ç•™æœ€è¿‘ 30 å¤©
- å•æ–‡ä»¶æœ€å¤§ 10MB

---

## 6. æ•°æ®æµè½¬

### 6.1 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. çª—å£æ ‡é¢˜è¯»å–                          â”‚
â”‚     Input: çª—å£æ ‡é¢˜                       â”‚
â”‚     Output: (song_name, artist_name)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æœç´¢ song_id                        â”‚
â”‚     Input: (song_name, artist_name)     â”‚
â”‚     Output: song_id                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è·å–æ­Œæ›²è¯¦æƒ…                         â”‚
â”‚     Input: song_id                     â”‚
â”‚     Output: SongInfo                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è·å–çƒ­é—¨è¯„è®º                         â”‚
â”‚     Input: song_id                     â”‚
â”‚     Output: List[Comment]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ˜¾ç¤ºè¯„è®ºè½®æ’­                         â”‚
â”‚     Input: SongInfo + List[Comment]    â”‚
â”‚     Output: ç•Œé¢æ›´æ–°                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ•°æ®è½¬æ¢

**çª—å£æ ‡é¢˜ â†’ æ­Œæ›²ä¿¡æ¯**:
```python
# Input
window_title = "æµªäººæƒ…æ­Œ - ä¼ä½°"

# Parse
parts = window_title.split(" - ")
song_name = parts[0]  # "æµªäººæƒ…æ­Œ"
artist_name = parts[1]  # "ä¼ä½°"

# Output
song_info = SongInfo(
    song_id="",  # å¾…æœç´¢
    name=song_name,
    artist=artist_name
)
```

**API å“åº” â†’ Comment**:
```python
# Input (API Response)
api_response = {
    "hotComments": [
        {
            "content": "è¯„è®ºå†…å®¹",
            "user": {"nickname": "ç”¨æˆ·A"},
            "likedCount": 123
        }
    ]
}

# Transform
comments = [
    Comment(
        content=item["content"],
        user=item["user"]["nickname"],
        likes=item["likedCount"]
    )
    for item in api_response["hotComments"]
]

# Output
List[Comment]
```

---

## 7. æ•°æ®éªŒè¯

### 7.1 è¾“å…¥éªŒè¯

**çª—å£æ ‡é¢˜éªŒè¯**:
```python
def validate_window_title(title: str) -> bool:
    """éªŒè¯çª—å£æ ‡é¢˜"""
    if not title:
        return False
    if not isinstance(title, str):
        return False
    if len(title) > 200:
        return False
    if ' - ' not in title:
        return False
    return True
```

**song_id éªŒè¯**:
```python
def validate_song_id(song_id: str) -> bool:
    """éªŒè¯ song_id"""
    if not song_id:
        return False
    if not song_id.isdigit():
        return False
    return True
```

### 7.2 è¾“å‡ºéªŒè¯

**SongInfo éªŒè¯**:
```python
def validate_song_info(song: SongInfo) -> bool:
    """éªŒè¯æ­Œæ›²ä¿¡æ¯"""
    if not song.song_id:
        return False
    if not song.name or not song.artist:
        return False
    if song.duration < 0:
        return False
    return True
```

---

## 8. æ•°æ®å­—å…¸æ€»ç»“

### 8.1 æ ¸å¿ƒæ•°æ®ç»“æ„

| åç§° | ç”¨é€” | å­˜å‚¨ä½ç½® | ç”Ÿå‘½å‘¨æœŸ |
|------|------|----------|----------|
| SongInfo | æ­Œæ›²ä¿¡æ¯ | å†…å­˜ | å½“å‰æ­Œæ›² |
| Comment | è¯„è®ºä¿¡æ¯ | å†…å­˜ | å½“å‰æ­Œæ›² |
| AppConfig | åº”ç”¨é…ç½® | æ–‡ä»¶ | æŒä¹…åŒ– |
| ç¼“å­˜æ•°æ® | æ€§èƒ½ä¼˜åŒ– | å†…å­˜ | TTL |

### 8.2 æ•°æ®å¤§å°ä¼°ç®—

| æ•°æ®ç±»å‹ | å•æ¡å¤§å° | æœ€å¤§æ•°é‡ | æ€»å¤§å° |
|----------|----------|----------|--------|
| SongInfo | ~500 bytes | 1 | 500 bytes |
| Comment | ~300 bytes | 20 | 6 KB |
| AppConfig | ~1 KB | 1 | 1 KB |
| ç¼“å­˜ (50é¦–) | ~10 KB | 50 | 500 KB |
| **æ€»è®¡** | - | - | **~510 KB** |

---

## 9. æ•°æ®å®‰å…¨

### 9.1 æ•°æ®éšç§

**ä¸æ”¶é›†çš„æ•°æ®**:
- âŒ ç”¨æˆ·è´¦å·ä¿¡æ¯
- âŒ å¬æ­Œå†å²è®°å½•
- âŒ ä¸ªäººèº«ä»½ä¿¡æ¯
- âŒ ä½¿ç”¨è¡Œä¸ºæ•°æ®

**ä»…å¤„ç†çš„æ•°æ®**:
- âœ… å…¬å¼€çš„æ­Œæ›²ä¿¡æ¯ï¼ˆæ­Œæ›²åã€æ­Œæ‰‹ï¼‰
- âœ… å…¬å¼€çš„è¯„è®ºå†…å®¹ï¼ˆç”¨æˆ·æ˜µç§°ã€è¯„è®ºå†…å®¹ï¼‰
- âœ… å…¬å¼€çš„éŸ³ä¹é£æ ¼ä¿¡æ¯

### 9.2 æ•°æ®ä¿æŠ¤

**ä¿æŠ¤æªæ–½**:
1. **æœ¬åœ°å­˜å‚¨**: æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°
2. **ä¸ä¸Šä¼ **: ä¸å‘ä»»ä½•è¿œç¨‹æœåŠ¡å™¨ä¸Šä¼ æ•°æ®
3. **æ˜æ–‡å­˜å‚¨**: é…ç½®æ–‡ä»¶æ˜æ–‡å­˜å‚¨ï¼ˆæ— æ•æ„Ÿä¿¡æ¯ï¼‰
4. **å®šæœŸæ¸…ç†**: æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨è½®è½¬ï¼Œå®šæœŸåˆ é™¤

---

## 10. é™„å½•

### 10.1 æ•°æ®ç±»å‹è¯´æ˜

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| str | å­—ç¬¦ä¸² | "æµªäººæƒ…æ­Œ" |
| int | æ•´æ•° | 12345 |
| float | æµ®ç‚¹æ•° | 0.85 |
| bool | å¸ƒå°”å€¼ | True/False |
| List[T] | åˆ—è¡¨ | ["æµè¡Œ", "æ‘‡æ»š"] |
| Optional[T] | å¯é€‰ç±»å‹ | None æˆ– T |

### 10.2 å­—æ®µçº¦æŸ

| çº¦æŸ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| å¿…å¡« | å­—æ®µå¿…é¡»æœ‰å€¼ | song_id |
| å”¯ä¸€ | å­—æ®µå€¼å¿…é¡»å”¯ä¸€ | song_id |
| é•¿åº¦ | å­—ç¬¦ä¸²æœ€å¤§é•¿åº¦ | name â‰¤ 200 |
| èŒƒå›´ | æ•°å€¼èŒƒå›´ | opacity 0-1 |

### 10.3 æšä¸¾å€¼

**è½®æ’­é—´éš”æšä¸¾**:
```python
ROTATION_INTERVALS = [3000, 5000, 7000, 10000]  # 3ç§’ã€5ç§’ã€7ç§’ã€10ç§’
```

**é€æ˜åº¦æšä¸¾**:
```python
OPACITY_LEVELS = [0.5, 0.7, 0.85, 1.0]  # 50%ã€70%ã€85%ã€100%
```

---

**æ–‡æ¡£ç»“æŸ**
